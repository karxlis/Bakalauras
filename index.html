<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>AR Placement & Shooting Combined v2 â€¢ A-Frame</title>
    <meta name="description" content="Place cubes via hit-test or shoot projectiles towards camera marker.">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/aframe-extras@7.2.0/dist/aframe-extras.min.js"></script>

    <link rel="stylesheet" href="style.css">

    <script src="script.js" defer></script>
  </head>
  <body>
    <a-scene
      id="myScene"
      reflection="directionalLight:a-light[type=directional]"
      ar-hit-test="target: #placement-reticle; type: footprint;"
      renderer="physicallyCorrectLights:true;colorManagement:true;exposure:1;toneMapping:ACESFilmic;"
      webxr="overlayElement:#dom-overlay; optionalFeatures: hit-test, dom-overlay;"
      cursor__mouse="rayOrigin: mouse;"
      cursor__xr="rayOrigin: controller;"
      raycaster="objects: .interactive;"
      vr-mode-ui="enterARButton: #myEnterARButton"
      background="color: #ECECEC;"
    >
      <a-assets>
        <a-mixin id="cursor_animations"
          animation__mouseenter="property: scale; to: 1.2 1.2 1.2; startEvents: mouseenter; dur: 200"
          animation__mouseleave="property: scale; to: 1 1 1; startEvents: mouseleave; dur: 200"
          animation__jump="startEvents:click;property:object3D.position.y;from: 0.5; to: 0.8; dir:alternate;loop:1;easing:easeOutQuad;dur:300;">
        </a-mixin>
      </a-assets>

      <a-light type="directional" light="castShadow:true;" position="1 1 1" intensity="0.5" shadow-camera-automatic=".interactive"></a-light>
      <a-light type="ambient" intensity="0.6"></a-light>

      <a-camera id="player-camera" position="0 0.4 0" wasd-controls="enabled: false;">
        <a-entity id="camera-aim-marker" position="0 -0.1 -1.5">
             <a-ring color="white" radius-inner="0.01" radius-outer="0.02"></a-ring>
        </a-entity>
      </a-camera>

      <a-entity id="objects" scale="0.2 0.2 0.2" position="0 0 -1" visible="true">
        <a-entity id="enemies"></a-entity>
      </a-entity>

      <a-plane follow-shadow="#objects" material="shader:shadow; transparent: true; opacity: 0.4;" shadow="cast:false; receive:true" rotation="-90 0 0" width="30" height="30"></a-plane>

      <a-sky color="#ECECEC" hide-on-enter-ar></a-sky>

      <a-entity id="placement-reticle" visible="false">
         <a-ring radius-inner="0.02" radius-outer="0.03" color="lightblue" rotation="-90 0 0"></a-ring>
      </a-entity>

      </a-scene> <section id="dom-overlay" class="hide-labels">
      <div id="tower-health-indicator" class="overlay-widget" style="top: 1em; left: 1em; display: none;">
        Tower Health: 10/10
      </div>
       <div id="scanning-feedback">Scanning for surfaces...<br>Move phone slowly.</div>
       <div id="level-up-popup">
        <div class="level-up-text">Level Up!</div>
        <div id="level-number">Level: 1</div>
      </div>
      <div id="place-tower-popup" style="display: none;">
        <div>Place Your Tower!</div>
        <div style="font-size: 0.8em; margin: 0.5em 0;">Tap the blue marker on a surface.</div>
        <button id="startGameButton" disabled>Start Game</button>
        <div id="tower-placed-feedback" style="font-size: 0.8em; margin-top: 0.5em; color: lightgreen; display: none;">Tower Placed!</div>
      </div>

      <div id="upgrades-popup" class="overlay-widget" style="top: 50%; left: 50%; transform: translate(-50%, -50%); display: none; text-align: center; padding: 1.5em; min-width: 250px;">
        <h2>Level Up! Choose Upgrade:</h2>
        <div class="upgrade-grid"> <button id="upgradeBtnHealth" class="upgrade-button">
            Tower Health <span class="upgrade-desc">(+3 Max HP)</span>
          </button>
          <button id="upgradeBtnShooter" class="upgrade-button">
            Add Shooter <span class="upgrade-desc">(Place Turret)</span>
          </button>
          <button id="upgradeBtnSpeed" class="upgrade-button">
            Shooting Speed <span class="upgrade-desc">(Future)</span>
          </button>
          <button id="upgradeBtnSlow" class="upgrade-button">
            Slowing Effect <span class="upgrade-desc">(Future)</span>
          </button>
          <button id="upgradeBtnShooterUpgrade" class="upgrade-button">
            Turret Synergy <span class="upgrade-desc">(Future)</span>
          </button>
        </div>
        <button id="closeUpgradePopupButton" style="margin-top: 1.5em; padding: 0.5em 1em;">Close</button>
      </div>
      <div id="confirm-placement-area" style="position: absolute; top: 1em; left: 50%; transform: translateX(-50%); z-index: 11; display: none;">
        <button id="confirmPlacementButton">Confirm Placement</button>
      </div>

      <div id="game-over-screen" class="overlay-widget" style="top: 50%; left: 50%; transform: translate(-50%, -50%); display: none; text-align: center; padding: 2em;">
        <h2>Game Over!</h2>
        <p id="final-score">Your Score: 0</p>
        <button id="tryAgainButton">Try Again</button>
      </div>

      <div id="controls-widget" style="inset:auto auto 1em 1em;" class="overlay-widget">
        <h1 style="margin: 0 0 0.5em 0;">AR Tower Defense</h1> <div id="score-display" style="margin-bottom: 1em; font-size: 1.1em; font-weight: bold;">Score: 0</div>
        <fieldset style="border:none; padding: 0;">
            <button id="myEnterARButton" onclick="document.querySelector('a-scene').enterAR()">Enter AR</button>
            <button id="exitVRButton" onclick="AFRAME.scenes[0].exitVR()" style="display: none;">Exit Immersive</button>
        <button id="shootButton">Shoot</button>
            <button id="manualUpgradesButton" style="margin-left: 1em;">Upgrades</button>
            </fieldset>
      </div>
      </section>

  </body>
</html>